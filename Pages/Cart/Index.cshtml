@page
@model OnlineBookStore.Pages.Cart.IndexModel
@{
    ViewData["Title"] = "用户购物车页面";
}

<head>
    <link rel="stylesheet" href="~/css/content.css" asp-append-version="true" />
	<link rel="stylesheet" href="~/css/cart.css" asp-append-version="true" />
	<link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
</head>

<main class="main-content">
    <div class="features-area">
		<!--购物车布局-->
		<div class="cart-layout">
			<!--购物车左部分, 放购物车项列表-->
			<div class="cart-layout-left">

				<div class="content-container">
					<span class="content-title">
						搜索购物车商品
					</span>
					<div class="content-body">
						<form method="get" asp-page="./Book/Search">
							<div class="search-bar">
								<input class="search-input" type="text" name="keyWord" placeholder="请输入商品名字..." />
								<button class="search-button" asp-page="/Cart/Index">搜索</button>
							</div>
						</form>
					</div>
				</div>

				<div class="content-container">
					<span class="content-title">
						购物车列表
					</span>
					<div class="cart-item-grid">
						@if (Model.CartItemViewModels != null && Model.CartItemViewModels.Count > 0)
						{
							foreach (var item in Model.CartItemViewModels)
							{
								<div class="cart-item-card">
									<a class="cart-item-cover-wrapper" asp-page="/Book/Index" asp-route-BookNumber="@item.BookNumber">
										@if (string.IsNullOrEmpty(item.BookCoverImageUrl))
										{
											<img src="item.BookCoverImageUrl" alt="@item.BookTitle" class="cart-item-cover-image"
													onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
											<div class="book-cover-placeholder">
												<span class="book-title-overlay">@item.BookTitle</span>
											</div>
										}
										else
										{
											<div class="book-cover-placeholder-display">
												<span class="book-title-overlay">@item.BookTitle</span>
											</div>
										}
									</a>
									<div class="cart-item-info-and-control">
										<div class="cart-item-details">
											<h3 class="cart-item-title">@item.BookTitle</h3>
											<!--<p class="cart-item-author">作者: </p>-->
											<p class="cart-item-quantity">单价: ¥@item.PriceString</p>
											<p class="cart-item-quantity">数量: @item.Count</p>
										</div>

										<div class="cart-item-down-part">
											<p class="cart-item-price">总价: ¥@item.TotalString</p>
											<!--移除购物车单项表单, 按下后, 将购物车单项的编号作为参数传递, 执行OnPostRemoveAsync方法-->
											<form method="post" asp-page-handler="RemoveItem" class="remove-item-form">
												<input type="hidden" name="cartItemNumber" value="@item.Number" />
												<button type="submit" class="remove-item-button">移除</button>
											</form>
										</div>
									</div>
								</div>
							}
						}
						else
						{
							<p>您的购物车为空。</p>
						}
					</div>

					<div class="page-change-body">
						<!-- 上一页按钮 -->
						<a asp-page="./Index" asp-route-keyWord="@Model.KeyWord" asp-route-pageIndex="@(Model.PageIndex - 1)"
							class="next-last-page-btn"
							disabled="@(Model.PageIndex <= 1)">
							上一页
						</a>

						<!-- 下一页按钮 -->
						<!--如果当前页面的购物车项小于十, 肯定说明没有下一页的内容了, 所以让按钮变灰-->
						<!--但是没有考虑刚刚好就剩十个的情况-->
						<a asp-page="./Index" asp-route-keyWord="@Model.KeyWord" asp-route-pageIndex="@(Model.PageIndex + 1)"
							class="next-last-page-btn"
							disabled="@(Model.CartItemViewModels!.Count < 10)">
							下一页
						</a>
					</div>
				</div>
			</div>
			<!--购物车右部分, 用于显示预计总额-->
			<div class="cart-layout-right">
				<!-- 右侧总额与操作栏 -->
				<div class="cart-summary">
					<h3>预计总额</h3>
					<p class="total-amount">¥@Model.CartViewModel.CartItemViewModels.Sum(i => i.Price * i.Count)</p>

					<!--这里使用表单提交, 但其实使用a元素跳转会更合理-->
					<!--[2025/10/20] 这里没有设定method的值默认是"post", 如果不设定的话, 会跳转到对应页面后执行对应页面的post方法, 这里先随便给个值先-->
					<form method="Create" asp-page="/Order/Create">
						@for (int i = 0; i < Model.CartItemViewModels!.Count; i++)
						{
							<input type="checkbox" name="OrderItems[@i].Selected" value="true" checked style="display:none" />
							<input type="hidden" name="OrderItems[@i].BookNumber" value="@Model.CartItemViewModels![i].BookNumber" />
							<input type="hidden" name="OrderItems[@i].Count" value="@Model.CartItemViewModels![i].Count" min="1" />
						}
						<button type="submit" class="checkout-button">为当前页面的购物车项创建订单</button>
					</form>

					<!--清空购物车表单, 按下后, 执行OnPostClearCartAsync方法-->
					<form method="post" asp-page-handler="ClearCart">
						<button type="submit" class="clear-cart-button">清空购物车</button>
					</form>
				</div>
			</div>
        </div>
    </div>
</main>